<!DOCTYPE html><html><head>
<script src="js/lib.js"></script>
<script src="lang.js"></script>
<script>
//init
opera.extension.tabs.addEventListener( "create", toggleIfExists, false);
opera.extension.tabs.addEventListener( "focus", toggleIfExists, false);
opera.extension.tabs.addEventListener( "blur", toggleIfExists, false);
opera.extension.addEventListener( "message", function(event)
    {
    switch(event.data.q)
	{
	case 'on':
	    toggleIfExists();
	break;
	case 'popup':
	    popupHelper(event);
	break;
	case 'size':
	    resizePopup(event.data.h);
	break;
	}
    }, false);

var theButton;
var ToolbarUIItemProperties =
    {
    title:lang.defTitle,
    icon:'icons/European-Union-Flag-16.png',
    disabled:true,
    badge:
	{
	display: "block",
	color: "white",
	backgroundColor: "rgba(0, 0, 0, 1)",
	textContent:'',
	},
    popup:
	{
	href: "popup.html",
	width: 200,
	height:230,
	}
    };
theButton = opera.contexts.toolbar.createItem(ToolbarUIItemProperties);
opera.contexts.toolbar.addItem(theButton);



//main function
function toggleIfExists()
    {
    //that is my key
    var key;
    if(widget.preferences.usekey=='0')//NB! if('0') is true
	key=widget.preferences.mykey;
    else
	key=widget.preferences.userkey;
    //~ opera.postError(key);
    
    //get data
    var fail=false;
    var tab=opera.extension.tabs.getFocused();
    if(!tab)
	fail=true;
    else
	{
	try
	    {
	    var url=tab.url;
	    if(!url)
		fail=true;
	    else
		{
		var re = new RegExp('^(?:f|ht)tp(?:s)?\://([^/]+)', 'im');
		var host=url.match(re)[1].toString();
		    if(!host)
			fail=true;
		}
	    }
	catch(e)
	    {
	    fail=true;
	    }
	}
    //~ opera.postError(host);
    
    if(fail)
	{
	theButton.title=lang.defTitle;
	theButton.icon='icons/European-Union-Flag-16.png';
	theButton.badge.textContent='';
	theButton.disabled=true;
	return;
	}
    
    //try cache
    if(!setIt(host))
	{
	//write to cache
	var XHR=new window.XMLHttpRequest();
	XHR.onreadystatechange=function()
	    {
	    if(XHR.readyState==4)
		{
		if(widget.preferences.length>1000)
		    clearCache();
		widget.preferences.setItem('cache:'+host,XHR.responseText);
		//~ opera.postError('i2cache:'+host+':'+XHR.responseText);
		setIt(host);
		}
	    };
	//~ XHR.open("GET","http://api.ipinfodb.com/v3/ip-country/?key="+key+"&ip="+host+"&format=json",true);
	//~ opera.postError("GET http://api.ipinfodb.com/v3/ip-city/?key="+key+"&ip="+host+"&format=json");
	XHR.open("GET","http://api.ipinfodb.com/v3/ip-city/?key="+key+"&ip="+host+"&format=json",true);
	XHR.send(null);
	}
    }



//cache helper
function setIt(host)
    {
    var q=widget.preferences.getItem('cache:'+host);
    //~ opera.postError(q);
    if(q)
	{
	//~ opera.postError('i4cache:'+host+':'+q);
	arg=JSON.parse(q);
	if(arg.statusCode=='OK')
	    {
	    theButton.title=arg.ipAddress+' - '+arg.countryName;
	    theButton.icon='flags/'+arg.countryCode.toLowerCase()+".png";
	    theButton.badge.textContent=arg.countryCode;
	    theButton.disabled=false;
	    }
	else
	    {
	    theButton.title=arg.ipAddress+' - '+arg.statusCode+': '+arg.statusMessage;
	    theButton.icon='icons/European-Union-Flag-16.png';
	    theButton.badge.textContent=arg.statusCode;
	    theButton.disabled=true;
	    }
	if(widget.preferences.showBadge==0)
	    theButton.badge.textContent='';
	return true;
	}
    else
	return false;
    }


// 'clearCache on exit' option
window.addEventListener('unload', function()
    {
    if(widget.preferences.cacheClear==1)
	clearCache();
    },false);



//almost like main
function popupHelper(event)
    {
    var key;
    if(widget.preferences.usekey=='0')//NB! if('0') is true
	key=widget.preferences.mykey;
    else
	key=widget.preferences.userkey;
    
    //get data
    var tab=opera.extension.tabs.getFocused();
    if(!tab) return;
    var url=tab.url;
    if(!url) return;
    var re = new RegExp('^(?:f|ht)tp(?:s)?\://([^/]+)', 'im');
    var host=url.match(re)[1].toString();
    //~ opera.postError(host);
    
    var q=widget.preferences.getItem('cache:'+host);
    if(q && (arg=JSON.parse(q)) && arg.cityName)//using new cache
	{
	arg=JSON.parse(q);
	arg.host=host;
	event.source.postMessage(arg);
	//~ opera.postError('p4cache:'+host+':'+q);
	}
    else
	{//retreive again, and save to cache
	var XHR=new window.XMLHttpRequest();
	XHR.onreadystatechange=function()
	    {
	    if(XHR.readyState==4)
		{
		widget.preferences.setItem('cache:'+host,XHR.responseText);
		arg=JSON.parse(XHR.responseText);
		arg.host=host;
		event.source.postMessage(arg);
		//~ opera.postError('p2cache:'+host+':'+XHR.responseText);
		}
	    };
	//~ opera.postError("GET http://api.ipinfodb.com/v3/ip-city/?key="+key+"&ip="+host+"&format=json");
	XHR.open("GET","http://api.ipinfodb.com/v3/ip-city/?key="+key+"&ip="+host+"&format=json",true);
	XHR.send(null);
	}
    
    //~ var XHR=new window.XMLHttpRequest();
    //~ XHR.onreadystatechange=function()
	//~ {
	//~ if(XHR.readyState==4)
	    //~ {
	    //~ arg=JSON.parse(XHR.responseText);
	    //~ arg.host=host;
	    //~ event.source.postMessage(arg);
	    //~ }
	//~ };
    //~ XHR.open("GET","http://api.ipinfodb.com/v3/ip-city/?key="+key+"&ip="+host+"&format=json",true);
    //~ XHR.send(null);
    }


function resizePopup(h)
    {
    //~ opera.postError('resizing to '+h);
    theButton.popup.height=h;
    }
</script>
</head><body></body></html>